generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Car {
  id               String   @id @default(cuid())
  dealerId         String?
  title            String
  brand            String
  model            String
  variant          String?
  price            BigInt
  year             Int
  fuelType         String
  transmission     String
  kmDriven         Int
  location         String
  images           Json     @default("[]")
  description      String
  sellerType       String
  postedDate       String
  owners           Int
  isVerified       Boolean  @default(false)
  isFeatured       Boolean  @default(false)
  dataSource       String
  olxProfile       String?
  olxProfileId     String?
  originalUrl      String?
  attribution      String?
  carStreetsListed Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  manuallyEdited   Boolean  @default(false)
  editedFields     Json     @default("[]")
  lastScrapedAt    DateTime @default(now())
  isUserAdded      Boolean  @default(false)
  scrapedData      Json?
  availability     String    @default("in_stock")
  countryOfOrigin  String    @default("IN")
  condition        String    @default("used")

  searchVector    String?
  tags            String[] @default([])
  viewCount       Int @default(0)
  leadCount       Int @default(0)
  
  slug            String?
  metaTitle       String?
  metaDescription String?

  contentEmbedding String?
  marketContext    Json?

  // ✅ ADD RELATIONS
  contentCalendar ContentCalendar[]
  dealer          Dealer? @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId, isVerified, carStreetsListed])
  @@index([brand, model, year])
  @@index([price, location])
  @@index([createdAt])
  @@map("cars")
}

model Dealer {
  id                  String   @id @default(cuid())
  name                String
  email               String   @unique
  
  subdomain           String   @unique
  customDomain        String?  @unique
  domainVerified      Boolean  @default(false)
  
  businessName        String?
  logo                String?
  phoneNumber         String?
  location            String?
  description         String?
  
  plan                String   @default("free")
  subscriptionStatus  String   @default("active")
  subscriptionAmount  Int?

  // Usage tracking for free tier
  carsCount          Int      @default(0)
  aiContentUsed      Int      @default(0)
  socialPostsUsed    Int      @default(0)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  cars                Car[]
  contentCalendar     ContentCalendar[]
  
  @@index([subdomain])
  @@index([customDomain])
  // REMOVE this line temporarily: @@map("dealers") 
}



model MarketIntelligence {
  id            String @id @default(cuid())
  source        String
  title         String
  content       String @db.Text
  summary       String?
  relevantFor   String[]
  sentiment     String?
  credibility   Float @default(0.8)
  
  contentEmbedding String?
  
  publishedAt   DateTime
  scrapedAt     DateTime @default(now())
  isActive      Boolean @default(true)
  
  @@index([source, isActive])
  @@index([publishedAt])
  @@map("market_intelligence")
}

model ContentTemplate {
  id           String @id @default(cuid())
  category     String
  template     String @db.Text
  variables    Json
  performance  Float @default(0.0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("content_templates")
}

model ContentCalendar {
  id       String @id @default(cuid())
  carId    String
  dealerId String?
  platform String

  textContent   String
  hashtags      String[]
  originalImage String?
  brandedImage  String?

  status        String    @default("draft")
  scheduledDate DateTime?
  approvedBy    String?
  approvedAt    DateTime?

  uniquenessScore Int      @default(92)
  generationCost  Float    @default(0.039)
  brandingApplied String[]

  autoGenerated  Boolean @default(true)
  requiresReview Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ ADD RELATIONS
  car    Car     @relation(fields: [carId], references: [id], onDelete: Cascade)
  dealer Dealer? @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([carId])
  @@index([status])
  @@index([scheduledDate])
}

model SocialMediaToken {
  id            String   @id @default(cuid())
  dealerId      String?
  platform      String
  accessToken   String
  refreshToken  String?
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  @@index([dealerId])
}

model SocialPost {
  id               String    @id @default(cuid())
  dealerId         String?
  platform         String
  status           String
  scheduledAt      DateTime?
  postedAt         DateTime?
  failureReason    String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  @@index([dealerId])
}

model WhatsAppContact {
  id           String   @id @default(cuid())
  dealerId     String?
  phoneNumber  String
  optedIn      Boolean  @default(false)
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  @@index([dealerId])
}

model FestivalContent {
  id         String   @id @default(cuid())
  dealerId   String?
  festival   String
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  @@index([dealerId])
}
